name: Terraform EKS Module Tests

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

# Prevent concurrent runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TERRAFORM_VERSION: "1.6.6"
  GO_VERSION: "1.21"
  AWS_REGION: "us-west-1"
  TFLINT_VERSION: "v0.50.3"
  AWS_ROLE_ARN: "arn:aws:iam::078963965848:role/joaoj-eks-test-pipeline"  # Replace with your OIDC role ARN

permissions:
  id-token: write  # Required for OIDC
  contents: read
  pull-requests: write

jobs:
  #############################################################################
  # Stage 1: Static Analysis (parallel)
  #############################################################################
  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff
        continue-on-error: false

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory:
          - modules/eks-cluster
          - examples/complete
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.directory }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ matrix.directory }}
        continue-on-error: false

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Initialize TFLint
        run: tflint --init

      - name: Run TFLint (modules)
        run: tflint --recursive --format=compact
        continue-on-error: false

  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
      checks: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy IaC scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'
          trivyignores: .trivyignore

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  #############################################################################
  # Stage 2: Unit Tests
  #############################################################################

  tests-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [terraform-fmt, terraform-validate, tflint, trivy]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: test/go.sum

      - name: Download dependencies
        run: go mod download
        working-directory: test

      - name: Run unit tests
        run: go test -v -short -timeout 5m ./...
        working-directory: test

  #############################################################################
  # Stage 3: Integration Tests (AWS)
  #############################################################################

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [tests-unit]
    # Only run on master branch or when explicitly requested
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'run-integration-tests')
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: terratest-eks-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false  # Required for Terratest

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: test/go.sum

      - name: Download dependencies
        run: go mod download
        working-directory: test

      - name: Run integration tests
        run: |
          go test -v -timeout 40m -run TestEksCluster ./...
        working-directory: test
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          TF_VAR_cluster_version: "1.29"

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ github.run_id }}
          path: |
            test/*.log
            examples/complete/*.tfplan
            examples/complete/terraform.tfstate*
          retention-days: 7

  #############################################################################
  # Cleanup job (runs even if integration tests fail)
  #############################################################################

  cleanup:
    name: Cleanup AWS Resources
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: always() && needs.integration-tests.result != 'skipped'
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: terratest-cleanup-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check for orphaned resources
        run: |
          echo "Checking for orphaned terratest resources..."

          # List EKS clusters with terratest prefix
          aws eks list-clusters --query "clusters[?starts_with(@, 'terratest-')]" --output text

          # List VPCs with terratest tag
          aws ec2 describe-vpcs \
            --filters "Name=tag:Test,Values=terratest" \
            --query "Vpcs[*].VpcId" \
            --output text

          echo "If resources exist, they may need manual cleanup"

  #############################################################################
  # Summary job
  #############################################################################

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [terraform-fmt, terraform-validate, tflint, trivy, tests-unit, integration-tests]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "Static Analysis Results:"
          echo "  - terraform-fmt: ${{ needs.terraform-fmt.result }}"
          echo "  - terraform-validate: ${{ needs.terraform-validate.result }}"
          echo "  - tflint: ${{ needs.tflint.result }}"
          echo "  - trivy: ${{ needs.trivy.result }}"
          echo ""
          echo "Test Results:"
          echo "  - tests-unit: ${{ needs.tests-unit.result }}"
          echo "  - integration-tests: ${{ needs.integration-tests.result }}"

          # Fail if any required job failed
          if [[ "${{ needs.terraform-fmt.result }}" == "failure" ]] || \
             [[ "${{ needs.terraform-validate.result }}" == "failure" ]] || \
             [[ "${{ needs.tflint.result }}" == "failure" ]] || \
             [[ "${{ needs.trivy.result }}" == "failure" ]] || \
             [[ "${{ needs.tests-unit.result }}" == "failure" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi

          echo "All required checks passed!"
