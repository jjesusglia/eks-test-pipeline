name: Terraform EKS Tests

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

# Prevent concurrent runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TERRAFORM_VERSION: "1.6.6"
  GO_VERSION: "1.21"
  AWS_REGION: "us-west-1"
  TFLINT_VERSION: "v0.50.3"
  AWS_ROLE_ARN: "arn:aws:iam::078963965848:role/joaoj-eks-test-pipeline"  # Replace with your OIDC role ARN

permissions:
  id-token: write  # Required for OIDC
  contents: read
  pull-requests: write

jobs:
  #############################################################################
  # Stage 1: Static Analysis (parallel)
  #############################################################################
  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff
        continue-on-error: false

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory:
          - modules/eks-cluster
          - examples/complete
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.directory }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ matrix.directory }}
        continue-on-error: false

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Initialize TFLint
        run: tflint --init

      - name: Run TFLint (modules)
        run: tflint --recursive --format=compact
        continue-on-error: false

  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
      checks: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy IaC scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'
          trivyignores: .trivyignore

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  #############################################################################
  # Stage 2: Unit Tests
  #############################################################################

  tests-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [terraform-fmt, terraform-validate, tflint, trivy]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: test/go.sum

      - name: Download dependencies
        run: go mod download
        working-directory: test

      - name: Run unit tests
        run: go test -v -short -timeout 5m ./...
        working-directory: test

  #############################################################################
  # Stage 3: Integration Tests (AWS)
  #############################################################################

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [tests-unit]
    # Only run on master branch or when explicitly requested
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'run-integration-tests')
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: terratest-eks-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false  # Required for Terratest

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: test/go.sum

      - name: Download dependencies
        run: go mod download
        working-directory: test

      - name: Run integration tests
        run: |
          go test -v -timeout 40m -run TestEksCluster ./...
        working-directory: test
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          TF_VAR_cluster_version: "1.29"
          TF_VAR_github_run_id: "${{ github.run_id }}"

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ github.run_id }}
          path: |
            test/*.log
            examples/complete/*.tfplan
            examples/complete/terraform.tfstate*
          retention-days: 7

  #############################################################################
  # Cleanup job (runs even if integration tests fail)
  #############################################################################

  cleanup:
    name: Cleanup AWS Resources
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: always() && needs.integration-tests.result != 'skipped'
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: terratest-cleanup-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Cleanup orphaned resources
        run: |
          set +e
          RUN_ID="${{ github.run_id }}"

          echo "========================================"
          echo "Cleanup for GitHub Run: $RUN_ID"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "========================================"

          # 1. Delete EKS Clusters
          echo "Finding EKS clusters for this run..."
          clusters=$(aws eks list-clusters --query "clusters[?starts_with(@, 'terratest-')]" --output text)

          for cluster in $clusters; do
            # Verify it's from this run
            run_tag=$(aws eks describe-cluster --name "$cluster" --query "cluster.tags.GitHubRunID" --output text 2>/dev/null)

            if [[ "$run_tag" == "$RUN_ID" ]]; then
              echo "Deleting EKS cluster: $cluster"

              # Delete node groups
              nodegroups=$(aws eks list-nodegroups --cluster-name "$cluster" --query "nodegroups" --output text)
              for ng in $nodegroups; do
                echo "  Deleting node group: $ng"
                aws eks delete-nodegroup --cluster-name "$cluster" --nodegroup-name "$ng" 2>/dev/null || true
              done

              # Delete add-ons
              addons=$(aws eks list-addons --cluster-name "$cluster" --query "addons" --output text 2>/dev/null)
              for addon in $addons; do
                echo "  Deleting add-on: $addon"
                aws eks delete-addon --cluster-name "$cluster" --addon-name "$addon" 2>/dev/null || true
              done

              # Delete cluster
              aws eks delete-cluster --name "$cluster" 2>/dev/null || true

              # Wait for deletion (max 30 iterations * 10s = 5 minutes)
              echo "  Waiting for cluster deletion..."
              for i in {1..30}; do
                if ! aws eks describe-cluster --name "$cluster" 2>/dev/null | grep -q "ACTIVE"; then
                  echo "  âœ“ Cluster deleted"
                  break
                fi
                sleep 10
              done
            fi
          done

          # 2. Delete VPCs and associated resources
          echo "Finding VPCs for this run..."
          vpcs=$(aws ec2 describe-vpcs \
            --filters "Name=tag:GitHubRunID,Values=$RUN_ID" \
            --query "Vpcs[*].VpcId" \
            --output text)

          for vpc in $vpcs; do
            echo "Cleaning up VPC: $vpc"

            # Delete NAT Gateways
            nats=$(aws ec2 describe-nat-gateways \
              --filter "Name=vpc-id,Values=$vpc" \
              --query "NatGateways[?State=='available'].NatGatewayId" \
              --output text)

            for nat in $nats; do
              echo "  Deleting NAT Gateway: $nat"
              aws ec2 delete-nat-gateway --nat-gateway-id "$nat" 2>/dev/null || true
            done

            # Wait for NAT deletion
            sleep 5

            # Release Elastic IPs
            eips=$(aws ec2 describe-addresses \
              --filter "Name=tag:GitHubRunID,Values=$RUN_ID" \
              --query "Addresses[?AssociationId==null].AllocationId" \
              --output text)

            for eip in $eips; do
              echo "  Releasing Elastic IP: $eip"
              aws ec2 release-address --allocation-id "$eip" 2>/dev/null || true
            done

            # Delete Security Groups
            sgs=$(aws ec2 describe-security-groups \
              --filters "Name=vpc-id,Values=$vpc" \
              --query "SecurityGroups[?GroupName!='default'].GroupId" \
              --output text)

            for sg in $sgs; do
              echo "  Deleting Security Group: $sg"
              aws ec2 delete-security-group --group-id "$sg" 2>/dev/null || true
            done

            # Delete Subnets
            subnets=$(aws ec2 describe-subnets \
              --filters "Name=vpc-id,Values=$vpc" \
              --query "Subnets[*].SubnetId" \
              --output text)

            for subnet in $subnets; do
              echo "  Deleting Subnet: $subnet"
              aws ec2 delete-subnet --subnet-id "$subnet" 2>/dev/null || true
            done

            # Delete Internet Gateways
            igws=$(aws ec2 describe-internet-gateways \
              --filters "Name=attachment.vpc-id,Values=$vpc" \
              --query "InternetGateways[*].InternetGatewayId" \
              --output text)

            for igw in $igws; do
              echo "  Detaching Internet Gateway: $igw"
              aws ec2 detach-internet-gateway --internet-gateway-id "$igw" --vpc-id "$vpc" 2>/dev/null || true
              aws ec2 delete-internet-gateway --internet-gateway-id "$igw" 2>/dev/null || true
            done

            # Delete VPC
            echo "  Deleting VPC: $vpc"
            aws ec2 delete-vpc --vpc-id "$vpc" 2>/dev/null || true
          done

          # 3. Delete CloudWatch Log Groups
          echo "Finding CloudWatch Log Groups for this run..."
          log_groups=$(aws logs describe-log-groups \
            --query "logGroups[?contains(logGroupName, 'terratest')].logGroupName" \
            --output text)

          for lg in $log_groups; do
            echo "Deleting Log Group: $lg"
            aws logs delete-log-group --log-group-name "$lg" 2>/dev/null || true
          done

          echo ""
          echo "Cleanup completed for Run ID: $RUN_ID"

  #############################################################################
  # Summary job
  #############################################################################

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [terraform-fmt, terraform-validate, tflint, trivy, tests-unit, integration-tests]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "Static Analysis Results:"
          echo "  - terraform-fmt: ${{ needs.terraform-fmt.result }}"
          echo "  - terraform-validate: ${{ needs.terraform-validate.result }}"
          echo "  - tflint: ${{ needs.tflint.result }}"
          echo "  - trivy: ${{ needs.trivy.result }}"
          echo ""
          echo "Test Results:"
          echo "  - tests-unit: ${{ needs.tests-unit.result }}"
          echo "  - integration-tests: ${{ needs.integration-tests.result }}"

          # Fail if any required job failed
          if [[ "${{ needs.terraform-fmt.result }}" == "failure" ]] || \
             [[ "${{ needs.terraform-validate.result }}" == "failure" ]] || \
             [[ "${{ needs.tflint.result }}" == "failure" ]] || \
             [[ "${{ needs.trivy.result }}" == "failure" ]] || \
             [[ "${{ needs.tests-unit.result }}" == "failure" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi

          echo "All required checks passed!"
